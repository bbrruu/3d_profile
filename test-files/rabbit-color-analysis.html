<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>兔子模型原始顏色檢測</title>
    <style>
        body { 
            margin: 0; 
            padding: 20px; 
            background: #1a1a1a; 
            color: white;
            font-family: 'Courier New', monospace;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #4a90e2;
        }
        .critical {
            border-left-color: #e74c3c;
        }
        .success {
            border-left-color: #2ecc71;
        }
        .warning {
            border-left-color: #f39c12;
        }
        #viewer {
            width: 800px;
            height: 600px;
            border: 2px solid #555;
            margin: 20px auto;
            background: #000;
        }
        .analysis {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 5px;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .model-info {
            background: #333;
            padding: 15px;
            border-radius: 5px;
        }
        .color-display {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .color-sample {
            width: 60px;
            height: 60px;
            border: 2px solid #666;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.8);
            position: relative;
        }
        .color-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #aaa;
        }
        button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
        }
        button:hover {
            background: #357abd;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .stat {
            background: #444;
            padding: 10px;
            border-radius: 3px;
            text-align: center;
        }
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #4a90e2;
        }
        .stat-label {
            font-size: 11px;
            color: #aaa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🐰 兔子模型原始顏色深度檢測</h1>
        
        <div class="section">
            <h2>檢測目的</h2>
            <p>深度分析兔子模型 (rabbit_hight-2.obj) 的原始顏色資訊，確定：</p>
            <ul>
                <li>模型是否包含原始顏色資訊</li>
                <li>原始材質的顏色狀況</li>
                <li>與 FBX 模型的顏色差異</li>
                <li>是否需要手動添加顏色</li>
            </ul>
            
            <div style="text-align: center; margin: 20px 0;">
                <button onclick="loadRabbit()">載入兔子模型</button>
                <button onclick="loadFBX()">載入 FBX 對比</button>
                <button onclick="compareColors()">比較顏色</button>
                <button onclick="testAppliedColors()">測試套用顏色</button>
            </div>
        </div>

        <div id="status-section" class="section">
            <h3>檢測狀態</h3>
            <div id="status">準備開始檢測...</div>
        </div>

        <div class="comparison">
            <div class="model-info">
                <h3>🐰 兔子模型 (OBJ)</h3>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="rabbit-meshes">0</div>
                        <div class="stat-label">網格數</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="rabbit-materials">0</div>
                        <div class="stat-label">材質數</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="rabbit-colors">0</div>
                        <div class="stat-label">有顏色</div>
                    </div>
                </div>
                <div class="color-display" id="rabbit-colors-display"></div>
            </div>
            
            <div class="model-info">
                <h3>📦 FBX 模型對比</h3>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="fbx-meshes">0</div>
                        <div class="stat-label">網格數</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="fbx-materials">0</div>
                        <div class="stat-label">材質數</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="fbx-colors">0</div>
                        <div class="stat-label">有顏色</div>
                    </div>
                </div>
                <div class="color-display" id="fbx-colors-display"></div>
            </div>
        </div>

        <div id="viewer"></div>

        <div id="results" style="display: none;">
            <div class="section success">
                <h2>📊 檢測結果</h2>
                <div id="conclusion"></div>
            </div>

            <div class="section">
                <h2>📋 詳細分析報告</h2>
                <div id="detailed-analysis" class="analysis"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/libs/fflate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/FBXLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>

    <script>
        let scene, camera, renderer;
        let rabbitModel, fbxModel;
        let currentModel;
        let analysisData = {
            rabbit: { meshes: 0, materials: 0, colors: [], hasColors: false },
            fbx: { meshes: 0, materials: 0, colors: [], hasColors: false }
        };

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            statusDiv.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            console.log(message);
        }

        function log(message) {
            const analysisDiv = document.getElementById('detailed-analysis');
            analysisDiv.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n`;
            analysisDiv.scrollTop = analysisDiv.scrollHeight;
        }

        function initViewer() {
            const container = document.getElementById('viewer');
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x2a2a2a);
            
            camera = new THREE.PerspectiveCamera(75, 800/600, 0.1, 1000);
            camera.position.set(5, 5, 5);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(800, 600);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);
            
            // 完整的光照設置
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.0);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            scene.add(directionalLight);
            
            animate();
        }

        function analyzeModel(model, type) {
            log(`=== 分析 ${type} 模型 ===`);
            
            const data = analysisData[type] = { meshes: 0, materials: 0, colors: [], hasColors: false };
            
            model.traverse(function(child) {
                if (child.isMesh) {
                    data.meshes++;
                    
                    log(`網格 ${data.meshes}: ${child.name || 'unnamed'}`);
                    
                    if (child.material) {
                        data.materials++;
                        
                        log(`  材質類型: ${child.material.type}`);
                        log(`  有材質: 是`);
                        
                        // 檢查顏色
                        if (child.material.color) {
                            const color = child.material.color;
                            const hex = '#' + color.getHexString();
                            const r = Math.round(color.r * 255);
                            const g = Math.round(color.g * 255);
                            const b = Math.round(color.b * 255);
                            
                            const colorInfo = {
                                hex: hex,
                                rgb: [r, g, b],
                                brightness: (r + g + b) / 3,
                                isWhite: r > 250 && g > 250 && b > 250,
                                isBlack: r < 5 && g < 5 && b < 5,
                                isGray: Math.abs(r - g) < 10 && Math.abs(g - b) < 10 && Math.abs(r - b) < 10
                            };
                            
                            data.colors.push(colorInfo);
                            data.hasColors = true;
                            
                            log(`  顏色: ${hex} RGB(${r}, ${g}, ${b})`);
                            log(`  亮度: ${colorInfo.brightness.toFixed(1)}`);
                            log(`  類型: ${colorInfo.isWhite ? '白色' : colorInfo.isBlack ? '黑色' : colorInfo.isGray ? '灰色' : '彩色'}`);
                        } else {
                            log(`  顏色: 無`);
                        }
                    } else {
                        log(`  材質: 無`);
                    }
                    log('  ---');
                }
            });
            
            // 更新UI
            updateModelStats(type, data);
            updateColorDisplay(type, data.colors);
            
            log(`${type} 模型分析完成: ${data.meshes} 網格, ${data.materials} 材質, ${data.colors.length} 顏色`);
        }

        function updateModelStats(type, data) {
            document.getElementById(`${type}-meshes`).textContent = data.meshes;
            document.getElementById(`${type}-materials`).textContent = data.materials;
            document.getElementById(`${type}-colors`).textContent = data.colors.length;
        }

        function updateColorDisplay(type, colors) {
            const container = document.getElementById(`${type}-colors-display`);
            container.innerHTML = '';
            
            if (colors.length === 0) {
                container.innerHTML = '<div style="color: #999; text-align: center; width: 100%;">無顏色資訊</div>';
                return;
            }
            
            colors.forEach((colorInfo, index) => {
                const colorDiv = document.createElement('div');
                colorDiv.className = 'color-sample';
                colorDiv.style.backgroundColor = colorInfo.hex;
                colorDiv.style.color = colorInfo.brightness > 128 ? '#000' : '#fff';
                colorDiv.textContent = colorInfo.hex;
                
                const label = document.createElement('div');
                label.className = 'color-label';
                label.textContent = `${colorInfo.brightness.toFixed(0)}`;
                colorDiv.appendChild(label);
                
                container.appendChild(colorDiv);
            });
        }

        function setupModel(model) {
            // 清除現有模型
            if (currentModel) {
                scene.remove(currentModel);
            }
            
            currentModel = model;
            
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            
            const maxDim = Math.max(size.x, size.y, size.z);
            const scale = 3 / maxDim;
            model.scale.setScalar(scale);
            
            // 重新計算縮放後的中心點
            const scaledBox = new THREE.Box3().setFromObject(model);
            const scaledCenter = scaledBox.getCenter(new THREE.Vector3());
            
            model.position.set(
                -scaledCenter.x,
                -scaledCenter.y,
                -scaledCenter.z
            );
            
            scene.add(model);
        }

        function loadRabbit() {
            updateStatus('載入兔子模型中...');
            log('=== 開始載入兔子模型 ===');
            
            const loader = new THREE.OBJLoader();
            loader.load(
                'models/rabbit_hight-2.obj',
                function(object) {
                    updateStatus('兔子模型載入成功，開始分析原始顏色...', 'success');
                    
                    rabbitModel = object;
                    
                    // 分析原始狀態（載入後但未添加材質前）
                    analyzeModel(rabbitModel, 'rabbit');
                    
                    // 設置顯示
                    setupModel(rabbitModel);
                    
                    updateStatus('✅ 兔子模型分析完成');
                    document.getElementById('results').style.display = 'block';
                },
                function(progress) {
                    const percent = progress.total > 0 ? Math.round((progress.loaded / progress.total) * 100) : 0;
                    updateStatus(`兔子模型載入進度: ${percent}%`);
                },
                function(error) {
                    updateStatus(`❌ 兔子模型載入失敗: ${error}`, 'error');
                    log(`錯誤詳情: ${error}`);
                }
            );
        }

        function loadFBX() {
            updateStatus('載入 FBX 模型中...');
            log('=== 開始載入 FBX 模型對比 ===');
            
            const loader = new THREE.FBXLoader();
            loader.load(
                'models/3D_sample.fbx',
                function(object) {
                    updateStatus('FBX 模型載入成功，開始分析...', 'success');
                    
                    fbxModel = object;
                    
                    // 分析 FBX 模型
                    analyzeModel(fbxModel, 'fbx');
                    
                    updateStatus('✅ FBX 模型分析完成');
                },
                function(progress) {
                    const percent = progress.total > 0 ? Math.round((progress.loaded / progress.total) * 100) : 0;
                    updateStatus(`FBX 載入進度: ${percent}%`);
                },
                function(error) {
                    updateStatus(`❌ FBX 載入失敗: ${error}`, 'error');
                }
            );
        }

        function compareColors() {
            if (!rabbitModel || !fbxModel) {
                alert('請先載入兩個模型');
                return;
            }
            
            log('');
            log('=== 顏色比較分析 ===');
            
            const rabbit = analysisData.rabbit;
            const fbx = analysisData.fbx;
            
            log(`兔子模型: ${rabbit.colors.length} 種顏色`);
            log(`FBX 模型: ${fbx.colors.length} 種顏色`);
            
            // 分析結論
            let conclusion = '';
            
            if (rabbit.colors.length === 0) {
                conclusion += '🔍 兔子模型原始檔案完全沒有顏色資訊\n';
                conclusion += '📝 這是 OBJ 格式的正常狀況，OBJ 檔案通常只包含幾何資訊\n';
                conclusion += '💡 需要手動添加材質和顏色\n\n';
            } else {
                conclusion += `✅ 兔子模型包含 ${rabbit.colors.length} 種顏色\n`;
                rabbit.colors.forEach((color, i) => {
                    conclusion += `   顏色 ${i+1}: ${color.hex} (${color.isWhite ? '白色' : color.isBlack ? '黑色' : '其他'})\n`;
                });
                conclusion += '\n';
            }
            
            if (fbx.colors.length > 0) {
                conclusion += `📦 FBX 模型包含 ${fbx.colors.length} 種顏色 (主要是白色 #ffffff)\n`;
                conclusion += '🎨 FBX 檔案保留了材質系統，但顏色是白色\n\n';
            }
            
            conclusion += '🎯 建議方案:\n';
            conclusion += '1. 為兔子模型手動添加適合的棕色/米色材質\n';
            conclusion += '2. 在角色建模項目中展示個性化的兔子角色\n';
            conclusion += '3. 提供顏色自訂功能讓用戶調整';
            
            document.getElementById('conclusion').innerHTML = `<pre>${conclusion}</pre>`;
            
            log('顏色比較分析完成');
        }

        function testAppliedColors() {
            if (!rabbitModel) {
                alert('請先載入兔子模型');
                return;
            }
            
            updateStatus('測試套用顏色到兔子模型...');
            log('=== 測試顏色套用 ===');
            
            // 為兔子添加不同的材質測試
            const testColors = [
                { name: '棕色', color: 0x8B4513 },
                { name: '米色', color: 0xF5F5DC },
                { name: '灰色', color: 0x808080 },
                { name: '白色', color: 0xFFFFFF }
            ];
            
            let colorIndex = 0;
            
            function applyNextColor() {
                const testColor = testColors[colorIndex];
                
                rabbitModel.traverse(function(child) {
                    if (child.isMesh) {
                        child.material = new THREE.MeshLambertMaterial({
                            color: testColor.color,
                            transparent: false,
                            opacity: 1.0
                        });
                    }
                });
                
                log(`套用 ${testColor.name} (${new THREE.Color(testColor.color).getHexString()})`);
                updateStatus(`已套用 ${testColor.name} 到兔子模型`);
                
                colorIndex = (colorIndex + 1) % testColors.length;
                
                if (colorIndex === 0) {
                    log('顏色測試完成');
                    updateStatus('✅ 所有顏色測試完成，兔子模型可以正常套用顏色');
                } else {
                    setTimeout(applyNextColor, 2000);
                }
            }
            
            applyNextColor();
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if (currentModel) {
                currentModel.rotation.y += 0.005;
            }
            
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }

        // 初始化
        initViewer();
        updateStatus('3D 環境已初始化，請開始檢測');
    </script>
</body>
</html>
