<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å…”å­æ¨¡å‹åŸå§‹é¡è‰²æª¢æ¸¬</title>
    <style>
        body { 
            margin: 0; 
            padding: 20px; 
            background: #1a1a1a; 
            color: white;
            font-family: 'Courier New', monospace;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border-left: 4px solid #4a90e2;
        }
        .critical {
            border-left-color: #e74c3c;
        }
        .success {
            border-left-color: #2ecc71;
        }
        .warning {
            border-left-color: #f39c12;
        }
        #viewer {
            width: 800px;
            height: 600px;
            border: 2px solid #555;
            margin: 20px auto;
            background: #000;
        }
        .analysis {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 5px;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .model-info {
            background: #333;
            padding: 15px;
            border-radius: 5px;
        }
        .color-display {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        .color-sample {
            width: 60px;
            height: 60px;
            border: 2px solid #666;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.8);
            position: relative;
        }
        .color-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #aaa;
        }
        button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
        }
        button:hover {
            background: #357abd;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .stat {
            background: #444;
            padding: 10px;
            border-radius: 3px;
            text-align: center;
        }
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #4a90e2;
        }
        .stat-label {
            font-size: 11px;
            color: #aaa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ° å…”å­æ¨¡å‹åŸå§‹é¡è‰²æ·±åº¦æª¢æ¸¬</h1>
        
        <div class="section">
            <h2>æª¢æ¸¬ç›®çš„</h2>
            <p>æ·±åº¦åˆ†æå…”å­æ¨¡å‹ (rabbit_hight-2.obj) çš„åŸå§‹é¡è‰²è³‡è¨Šï¼Œç¢ºå®šï¼š</p>
            <ul>
                <li>æ¨¡å‹æ˜¯å¦åŒ…å«åŸå§‹é¡è‰²è³‡è¨Š</li>
                <li>åŸå§‹æè³ªçš„é¡è‰²ç‹€æ³</li>
                <li>èˆ‡ FBX æ¨¡å‹çš„é¡è‰²å·®ç•°</li>
                <li>æ˜¯å¦éœ€è¦æ‰‹å‹•æ·»åŠ é¡è‰²</li>
            </ul>
            
            <div style="text-align: center; margin: 20px 0;">
                <button onclick="loadRabbit()">è¼‰å…¥å…”å­æ¨¡å‹</button>
                <button onclick="loadFBX()">è¼‰å…¥ FBX å°æ¯”</button>
                <button onclick="compareColors()">æ¯”è¼ƒé¡è‰²</button>
                <button onclick="testAppliedColors()">æ¸¬è©¦å¥—ç”¨é¡è‰²</button>
            </div>
        </div>

        <div id="status-section" class="section">
            <h3>æª¢æ¸¬ç‹€æ…‹</h3>
            <div id="status">æº–å‚™é–‹å§‹æª¢æ¸¬...</div>
        </div>

        <div class="comparison">
            <div class="model-info">
                <h3>ğŸ° å…”å­æ¨¡å‹ (OBJ)</h3>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="rabbit-meshes">0</div>
                        <div class="stat-label">ç¶²æ ¼æ•¸</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="rabbit-materials">0</div>
                        <div class="stat-label">æè³ªæ•¸</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="rabbit-colors">0</div>
                        <div class="stat-label">æœ‰é¡è‰²</div>
                    </div>
                </div>
                <div class="color-display" id="rabbit-colors-display"></div>
            </div>
            
            <div class="model-info">
                <h3>ğŸ“¦ FBX æ¨¡å‹å°æ¯”</h3>
                <div class="stats">
                    <div class="stat">
                        <div class="stat-value" id="fbx-meshes">0</div>
                        <div class="stat-label">ç¶²æ ¼æ•¸</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="fbx-materials">0</div>
                        <div class="stat-label">æè³ªæ•¸</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="fbx-colors">0</div>
                        <div class="stat-label">æœ‰é¡è‰²</div>
                    </div>
                </div>
                <div class="color-display" id="fbx-colors-display"></div>
            </div>
        </div>

        <div id="viewer"></div>

        <div id="results" style="display: none;">
            <div class="section success">
                <h2>ğŸ“Š æª¢æ¸¬çµæœ</h2>
                <div id="conclusion"></div>
            </div>

            <div class="section">
                <h2>ğŸ“‹ è©³ç´°åˆ†æå ±å‘Š</h2>
                <div id="detailed-analysis" class="analysis"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/libs/fflate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/FBXLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>

    <script>
        let scene, camera, renderer;
        let rabbitModel, fbxModel;
        let currentModel;
        let analysisData = {
            rabbit: { meshes: 0, materials: 0, colors: [], hasColors: false },
            fbx: { meshes: 0, materials: 0, colors: [], hasColors: false }
        };

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            statusDiv.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            console.log(message);
        }

        function log(message) {
            const analysisDiv = document.getElementById('detailed-analysis');
            analysisDiv.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n`;
            analysisDiv.scrollTop = analysisDiv.scrollHeight;
        }

        function initViewer() {
            const container = document.getElementById('viewer');
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x2a2a2a);
            
            camera = new THREE.PerspectiveCamera(75, 800/600, 0.1, 1000);
            camera.position.set(5, 5, 5);
            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(800, 600);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);
            
            // å®Œæ•´çš„å…‰ç…§è¨­ç½®
            const ambientLight = new THREE.AmbientLight(0xffffff, 1.0);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 10, 5);
            scene.add(directionalLight);
            
            animate();
        }

        function analyzeModel(model, type) {
            log(`=== åˆ†æ ${type} æ¨¡å‹ ===`);
            
            const data = analysisData[type] = { meshes: 0, materials: 0, colors: [], hasColors: false };
            
            model.traverse(function(child) {
                if (child.isMesh) {
                    data.meshes++;
                    
                    log(`ç¶²æ ¼ ${data.meshes}: ${child.name || 'unnamed'}`);
                    
                    if (child.material) {
                        data.materials++;
                        
                        log(`  æè³ªé¡å‹: ${child.material.type}`);
                        log(`  æœ‰æè³ª: æ˜¯`);
                        
                        // æª¢æŸ¥é¡è‰²
                        if (child.material.color) {
                            const color = child.material.color;
                            const hex = '#' + color.getHexString();
                            const r = Math.round(color.r * 255);
                            const g = Math.round(color.g * 255);
                            const b = Math.round(color.b * 255);
                            
                            const colorInfo = {
                                hex: hex,
                                rgb: [r, g, b],
                                brightness: (r + g + b) / 3,
                                isWhite: r > 250 && g > 250 && b > 250,
                                isBlack: r < 5 && g < 5 && b < 5,
                                isGray: Math.abs(r - g) < 10 && Math.abs(g - b) < 10 && Math.abs(r - b) < 10
                            };
                            
                            data.colors.push(colorInfo);
                            data.hasColors = true;
                            
                            log(`  é¡è‰²: ${hex} RGB(${r}, ${g}, ${b})`);
                            log(`  äº®åº¦: ${colorInfo.brightness.toFixed(1)}`);
                            log(`  é¡å‹: ${colorInfo.isWhite ? 'ç™½è‰²' : colorInfo.isBlack ? 'é»‘è‰²' : colorInfo.isGray ? 'ç°è‰²' : 'å½©è‰²'}`);
                        } else {
                            log(`  é¡è‰²: ç„¡`);
                        }
                    } else {
                        log(`  æè³ª: ç„¡`);
                    }
                    log('  ---');
                }
            });
            
            // æ›´æ–°UI
            updateModelStats(type, data);
            updateColorDisplay(type, data.colors);
            
            log(`${type} æ¨¡å‹åˆ†æå®Œæˆ: ${data.meshes} ç¶²æ ¼, ${data.materials} æè³ª, ${data.colors.length} é¡è‰²`);
        }

        function updateModelStats(type, data) {
            document.getElementById(`${type}-meshes`).textContent = data.meshes;
            document.getElementById(`${type}-materials`).textContent = data.materials;
            document.getElementById(`${type}-colors`).textContent = data.colors.length;
        }

        function updateColorDisplay(type, colors) {
            const container = document.getElementById(`${type}-colors-display`);
            container.innerHTML = '';
            
            if (colors.length === 0) {
                container.innerHTML = '<div style="color: #999; text-align: center; width: 100%;">ç„¡é¡è‰²è³‡è¨Š</div>';
                return;
            }
            
            colors.forEach((colorInfo, index) => {
                const colorDiv = document.createElement('div');
                colorDiv.className = 'color-sample';
                colorDiv.style.backgroundColor = colorInfo.hex;
                colorDiv.style.color = colorInfo.brightness > 128 ? '#000' : '#fff';
                colorDiv.textContent = colorInfo.hex;
                
                const label = document.createElement('div');
                label.className = 'color-label';
                label.textContent = `${colorInfo.brightness.toFixed(0)}`;
                colorDiv.appendChild(label);
                
                container.appendChild(colorDiv);
            });
        }

        function setupModel(model) {
            // æ¸…é™¤ç¾æœ‰æ¨¡å‹
            if (currentModel) {
                scene.remove(currentModel);
            }
            
            currentModel = model;
            
            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            
            const maxDim = Math.max(size.x, size.y, size.z);
            const scale = 3 / maxDim;
            model.scale.setScalar(scale);
            
            // é‡æ–°è¨ˆç®—ç¸®æ”¾å¾Œçš„ä¸­å¿ƒé»
            const scaledBox = new THREE.Box3().setFromObject(model);
            const scaledCenter = scaledBox.getCenter(new THREE.Vector3());
            
            model.position.set(
                -scaledCenter.x,
                -scaledCenter.y,
                -scaledCenter.z
            );
            
            scene.add(model);
        }

        function loadRabbit() {
            updateStatus('è¼‰å…¥å…”å­æ¨¡å‹ä¸­...');
            log('=== é–‹å§‹è¼‰å…¥å…”å­æ¨¡å‹ ===');
            
            const loader = new THREE.OBJLoader();
            loader.load(
                'models/rabbit_hight-2.obj',
                function(object) {
                    updateStatus('å…”å­æ¨¡å‹è¼‰å…¥æˆåŠŸï¼Œé–‹å§‹åˆ†æåŸå§‹é¡è‰²...', 'success');
                    
                    rabbitModel = object;
                    
                    // åˆ†æåŸå§‹ç‹€æ…‹ï¼ˆè¼‰å…¥å¾Œä½†æœªæ·»åŠ æè³ªå‰ï¼‰
                    analyzeModel(rabbitModel, 'rabbit');
                    
                    // è¨­ç½®é¡¯ç¤º
                    setupModel(rabbitModel);
                    
                    updateStatus('âœ… å…”å­æ¨¡å‹åˆ†æå®Œæˆ');
                    document.getElementById('results').style.display = 'block';
                },
                function(progress) {
                    const percent = progress.total > 0 ? Math.round((progress.loaded / progress.total) * 100) : 0;
                    updateStatus(`å…”å­æ¨¡å‹è¼‰å…¥é€²åº¦: ${percent}%`);
                },
                function(error) {
                    updateStatus(`âŒ å…”å­æ¨¡å‹è¼‰å…¥å¤±æ•—: ${error}`, 'error');
                    log(`éŒ¯èª¤è©³æƒ…: ${error}`);
                }
            );
        }

        function loadFBX() {
            updateStatus('è¼‰å…¥ FBX æ¨¡å‹ä¸­...');
            log('=== é–‹å§‹è¼‰å…¥ FBX æ¨¡å‹å°æ¯” ===');
            
            const loader = new THREE.FBXLoader();
            loader.load(
                'models/3D_sample.fbx',
                function(object) {
                    updateStatus('FBX æ¨¡å‹è¼‰å…¥æˆåŠŸï¼Œé–‹å§‹åˆ†æ...', 'success');
                    
                    fbxModel = object;
                    
                    // åˆ†æ FBX æ¨¡å‹
                    analyzeModel(fbxModel, 'fbx');
                    
                    updateStatus('âœ… FBX æ¨¡å‹åˆ†æå®Œæˆ');
                },
                function(progress) {
                    const percent = progress.total > 0 ? Math.round((progress.loaded / progress.total) * 100) : 0;
                    updateStatus(`FBX è¼‰å…¥é€²åº¦: ${percent}%`);
                },
                function(error) {
                    updateStatus(`âŒ FBX è¼‰å…¥å¤±æ•—: ${error}`, 'error');
                }
            );
        }

        function compareColors() {
            if (!rabbitModel || !fbxModel) {
                alert('è«‹å…ˆè¼‰å…¥å…©å€‹æ¨¡å‹');
                return;
            }
            
            log('');
            log('=== é¡è‰²æ¯”è¼ƒåˆ†æ ===');
            
            const rabbit = analysisData.rabbit;
            const fbx = analysisData.fbx;
            
            log(`å…”å­æ¨¡å‹: ${rabbit.colors.length} ç¨®é¡è‰²`);
            log(`FBX æ¨¡å‹: ${fbx.colors.length} ç¨®é¡è‰²`);
            
            // åˆ†æçµè«–
            let conclusion = '';
            
            if (rabbit.colors.length === 0) {
                conclusion += 'ğŸ” å…”å­æ¨¡å‹åŸå§‹æª”æ¡ˆå®Œå…¨æ²’æœ‰é¡è‰²è³‡è¨Š\n';
                conclusion += 'ğŸ“ é€™æ˜¯ OBJ æ ¼å¼çš„æ­£å¸¸ç‹€æ³ï¼ŒOBJ æª”æ¡ˆé€šå¸¸åªåŒ…å«å¹¾ä½•è³‡è¨Š\n';
                conclusion += 'ğŸ’¡ éœ€è¦æ‰‹å‹•æ·»åŠ æè³ªå’Œé¡è‰²\n\n';
            } else {
                conclusion += `âœ… å…”å­æ¨¡å‹åŒ…å« ${rabbit.colors.length} ç¨®é¡è‰²\n`;
                rabbit.colors.forEach((color, i) => {
                    conclusion += `   é¡è‰² ${i+1}: ${color.hex} (${color.isWhite ? 'ç™½è‰²' : color.isBlack ? 'é»‘è‰²' : 'å…¶ä»–'})\n`;
                });
                conclusion += '\n';
            }
            
            if (fbx.colors.length > 0) {
                conclusion += `ğŸ“¦ FBX æ¨¡å‹åŒ…å« ${fbx.colors.length} ç¨®é¡è‰² (ä¸»è¦æ˜¯ç™½è‰² #ffffff)\n`;
                conclusion += 'ğŸ¨ FBX æª”æ¡ˆä¿ç•™äº†æè³ªç³»çµ±ï¼Œä½†é¡è‰²æ˜¯ç™½è‰²\n\n';
            }
            
            conclusion += 'ğŸ¯ å»ºè­°æ–¹æ¡ˆ:\n';
            conclusion += '1. ç‚ºå…”å­æ¨¡å‹æ‰‹å‹•æ·»åŠ é©åˆçš„æ£•è‰²/ç±³è‰²æè³ª\n';
            conclusion += '2. åœ¨è§’è‰²å»ºæ¨¡é …ç›®ä¸­å±•ç¤ºå€‹æ€§åŒ–çš„å…”å­è§’è‰²\n';
            conclusion += '3. æä¾›é¡è‰²è‡ªè¨‚åŠŸèƒ½è®“ç”¨æˆ¶èª¿æ•´';
            
            document.getElementById('conclusion').innerHTML = `<pre>${conclusion}</pre>`;
            
            log('é¡è‰²æ¯”è¼ƒåˆ†æå®Œæˆ');
        }

        function testAppliedColors() {
            if (!rabbitModel) {
                alert('è«‹å…ˆè¼‰å…¥å…”å­æ¨¡å‹');
                return;
            }
            
            updateStatus('æ¸¬è©¦å¥—ç”¨é¡è‰²åˆ°å…”å­æ¨¡å‹...');
            log('=== æ¸¬è©¦é¡è‰²å¥—ç”¨ ===');
            
            // ç‚ºå…”å­æ·»åŠ ä¸åŒçš„æè³ªæ¸¬è©¦
            const testColors = [
                { name: 'æ£•è‰²', color: 0x8B4513 },
                { name: 'ç±³è‰²', color: 0xF5F5DC },
                { name: 'ç°è‰²', color: 0x808080 },
                { name: 'ç™½è‰²', color: 0xFFFFFF }
            ];
            
            let colorIndex = 0;
            
            function applyNextColor() {
                const testColor = testColors[colorIndex];
                
                rabbitModel.traverse(function(child) {
                    if (child.isMesh) {
                        child.material = new THREE.MeshLambertMaterial({
                            color: testColor.color,
                            transparent: false,
                            opacity: 1.0
                        });
                    }
                });
                
                log(`å¥—ç”¨ ${testColor.name} (${new THREE.Color(testColor.color).getHexString()})`);
                updateStatus(`å·²å¥—ç”¨ ${testColor.name} åˆ°å…”å­æ¨¡å‹`);
                
                colorIndex = (colorIndex + 1) % testColors.length;
                
                if (colorIndex === 0) {
                    log('é¡è‰²æ¸¬è©¦å®Œæˆ');
                    updateStatus('âœ… æ‰€æœ‰é¡è‰²æ¸¬è©¦å®Œæˆï¼Œå…”å­æ¨¡å‹å¯ä»¥æ­£å¸¸å¥—ç”¨é¡è‰²');
                } else {
                    setTimeout(applyNextColor, 2000);
                }
            }
            
            applyNextColor();
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if (currentModel) {
                currentModel.rotation.y += 0.005;
            }
            
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }

        // åˆå§‹åŒ–
        initViewer();
        updateStatus('3D ç’°å¢ƒå·²åˆå§‹åŒ–ï¼Œè«‹é–‹å§‹æª¢æ¸¬');
    </script>
</body>
</html>
