<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>建築視覺化展示 - 3D 建築模型展示</title>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            font-family: 'Arial', sans-serif;
            min-height: 100vh;
        }
        .header {
            background: rgba(0, 0, 0, 0.8);
            padding: 20px 0;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        .header p {
            margin: 10px 0 0 0;
            font-size: 1.2em;
            opacity: 0.9;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .showcase {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin: 30px 0;
        }
        #viewer {
            width: 100%;
            height: 600px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }
        .controls {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .control-section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border-left: 4px solid #e74c3c;
        }
        .control-section h3 {
            margin-top: 0;
            color: #f39c12;
        }
        .environment-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        .env-btn {
            height: 50px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
            transition: all 0.3s ease;
            background: linear-gradient(45deg, #333, #555);
            color: white;
        }
        .env-btn:hover {
            border-color: #f39c12;
            transform: scale(1.05);
        }
        .env-btn.daylight { background: linear-gradient(45deg, #87CEEB, #4682B4); }
        .env-btn.sunset { background: linear-gradient(45deg, #FF8C00, #FF4500); }
        .env-btn.night { background: linear-gradient(45deg, #191970, #000080); }
        .env-btn.cloudy { background: linear-gradient(45deg, #708090, #2F4F4F); }
        
        button {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 20px;
            margin: 8px 0;
            border-radius: 25px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        button:hover {
            background: linear-gradient(45deg, #c0392b, #a93226);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }
        .info-panel {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .status {
            background: rgba(231, 76, 60, 0.2);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #e74c3c;
            margin: 15px 0;
        }
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .feature {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .feature h3 {
            color: #f39c12;
            margin-bottom: 15px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
        }
        .navigation {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }
        .nav-btn {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            text-decoration: none;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .nav-btn:hover {
            background: rgba(231, 76, 60, 0.7);
        }
        .arch-specs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 15px 0;
        }
        .spec-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        .lighting-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="navigation">
        <a href="index.html" class="nav-btn">← 返回主頁</a>
    </div>

    <div class="header">
        <h1>🏢 建築視覺化展示</h1>
        <p>3D 建築模型與環境視覺化 - 專業建築設計展示</p>
    </div>

    <div class="container">
        <div class="status">
            <h3>📊 建築狀態</h3>
            <div id="model-status">初始化中...</div>
        </div>

        <div class="showcase">
            <div id="viewer">
                <div class="loading" id="loading">
                    <h3>🔄 載入建築模型中...</h3>
                    <p>請稍候，正在載入 3D 建築模型</p>
                </div>
            </div>

            <div class="controls">
                <div class="control-section">
                    <h3>🌅 環境光照</h3>
                    <div class="environment-grid">
                        <div class="env-btn daylight" onclick="setEnvironment('daylight')">日光模式</div>
                        <div class="env-btn sunset" onclick="setEnvironment('sunset')">黃昏模式</div>
                        <div class="env-btn night" onclick="setEnvironment('night')">夜晚模式</div>
                        <div class="env-btn cloudy" onclick="setEnvironment('cloudy')">陰天模式</div>
                    </div>
                    <button onclick="randomizeEnvironment()">🎲 隨機環境</button>
                </div>

                <div class="control-section">
                    <h3>💡 光照控制</h3>
                    <div class="lighting-controls">
                        <button onclick="toggleInteriorLights()">🏠 室內燈光</button>
                        <button onclick="toggleShadows()">🌑 陰影效果</button>
                    </div>
                    <button onclick="adjustAmbientLight()">☀️ 環境光調整</button>
                </div>

                <div class="control-section">
                    <h3>⚙️ 視角控制</h3>
                    <button onclick="resetView()">🔄 重置視角</button>
                    <button onclick="toggleWireframe()">📐 線框模式</button>
                    <button onclick="captureScreenshot()">📸 截圖</button>
                </div>

                <div class="control-section">
                    <h3>🔧 建築工具</h3>
                    <button onclick="showFloorPlan()">📋 平面圖</button>
                    <button onclick="showBuildingSpecs()">📏 建築規格</button>
                    <button onclick="exportProject()">💾 匯出專案</button>
                </div>
            </div>
        </div>

        <div class="features">
            <div class="feature">
                <h3>🏗️ 建築建模</h3>
                <p>專業的 3D 建築建模服務，從概念設計到完整建築，提供逼真的視覺化展示。</p>
            </div>
            <div class="feature">
                <h3>🌈 環境渲染</h3>
                <p>多樣化的環境光照設置，包含日光、黃昏、夜晚等不同時段的光照效果。</p>
            </div>
            <div class="feature">
                <h3>💼 專業應用</h3>
                <p>適合建築提案、設計競圖、客戶展示等專業用途，提升建築設計表現力。</p>
            </div>
        </div>

        <div class="info-panel">
            <h3>📋 建築規格</h3>
            <div class="arch-specs">
                <div class="spec-item">
                    <strong>檔案格式</strong><br>
                    <span id="file-format">FBX</span>
                </div>
                <div class="spec-item">
                    <strong>當前環境</strong><br>
                    <span id="current-environment">日光</span>
                </div>
                <div class="spec-item">
                    <strong>光照狀態</strong><br>
                    <span id="lighting-status">自然光</span>
                </div>
                <div class="spec-item">
                    <strong>模型複雜度</strong><br>
                    <span id="mesh-count">載入中...</span>
                </div>
            </div>
            
            <div id="tech-specs" style="margin-top: 20px;">
                <p><strong>建築類型:</strong> 現代住宅建築</p>
                <p><strong>渲染模式:</strong> 建築級光照渲染</p>
                <p><strong>光照系統:</strong> 專業建築視覺化光照</p>
                <p><strong>適用領域:</strong> 建築設計、室內設計、景觀設計</p>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/libs/fflate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/FBXLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        let scene, camera, renderer, controls;
        let buildingModel;
        let wireframeMode = false;
        let currentEnvironment = 'daylight';
        let ambientLight, directionalLight, interiorLights = [];
        let shadowsEnabled = true;
        let interiorLightsOn = false;

        function updateStatus(message) {
            document.getElementById('model-status').textContent = message;
            console.log(message);
        }

        function init() {
            const container = document.getElementById('viewer');
            
            // 清除載入提示
            container.innerHTML = '';
            
            // 場景設定
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB); // 天空藍
            
            // 相機設定
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / 600, 0.1, 1000);
            camera.position.set(10, 8, 15);
            
            // 渲染器設定
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(container.clientWidth, 600);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            container.appendChild(renderer.domElement);
            
            // 控制器
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 0.5;
            controls.minDistance = 5;
            controls.maxDistance = 50;
            
            // 設置建築級光照
            setupArchitecturalLighting();
            
            // 添加地面
            const groundGeometry = new THREE.PlaneGeometry(50, 50);
            const groundMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x3e8e41,
                transparent: false
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -1;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // 載入建築模型
            loadBuildingModel();
            
            // 開始動畫
            animate();
        }

        function setupArchitecturalLighting() {
            // 環境光
            ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambientLight);
            
            // 主要太陽光
            directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
            directionalLight.position.set(20, 20, 10);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            directionalLight.shadow.camera.near = 0.5;
            directionalLight.shadow.camera.far = 50;
            directionalLight.shadow.camera.left = -25;
            directionalLight.shadow.camera.right = 25;
            directionalLight.shadow.camera.top = 25;
            directionalLight.shadow.camera.bottom = -25;
            scene.add(directionalLight);
            
            // 天空光
            const skyLight = new THREE.DirectionalLight(0x87CEEB, 0.3);
            skyLight.position.set(-10, 10, -10);
            scene.add(skyLight);
        }

        function loadBuildingModel() {
            updateStatus('載入建築模型 Minnan.fbx...');
            console.log('開始載入 Minnan.fbx');
            
            // 檢查 FBXLoader 是否可用
            if (typeof THREE.FBXLoader === 'undefined') {
                console.error('FBXLoader 未載入');
                updateStatus('❌ FBXLoader 未找到，使用替代模型...');
                loadAlternativeBuilding();
                return;
            }
            
            console.log('FBXLoader 可用，開始載入...');
            const loader = new THREE.FBXLoader();
            
            loader.load(
                'models/Minnan.fbx',
                function(object) {
                    console.log('✅ Minnan.fbx 載入成功！', object);
                    updateStatus('✅ 建築模型 Minnan.fbx 載入成功！');
                    
                    buildingModel = object;
                    
                    // 檢查模型內容
                    let meshCount = 0;
                    object.traverse(function(child) {
                        if (child.isMesh) {
                            meshCount++;
                            console.log(`發現建築網格 ${meshCount}:`, child.name, child.geometry, child.material);
                        }
                    });
                    console.log(`建築總共發現 ${meshCount} 個網格`);
                    
                    // 為建築添加材質
                    buildingModel.traverse(function(child) {
                        if (child.isMesh) {
                            child.castShadow = true;
                            child.receiveShadow = true;
                            
                            // 建築材質處理
                            try {
                                if (!child.material) {
                                    console.log('建築網格無材質，添加預設建築材質');
                                    child.material = new THREE.MeshLambertMaterial({
                                        color: 0xf0f0f0
                                    });
                                } else if (Array.isArray(child.material)) {
                                    console.log('處理建築材質陣列');
                                    child.material = child.material.map(mat => {
                                        if (mat && mat.clone) {
                                            return mat.clone();
                                        }
                                        return new THREE.MeshLambertMaterial({
                                            color: 0xf0f0f0
                                        });
                                    });
                                } else {
                                    console.log('保持原始建築材質');
                                    // 保持原始建築材質，如果可能的話
                                    if (child.material.clone) {
                                        child.material = child.material.clone();
                                    }
                                }
                            } catch (error) {
                                console.log('建築材質處理錯誤:', error);
                                child.material = new THREE.MeshLambertMaterial({
                                    color: 0xf0f0f0
                                });
                            }
                        }
                    });
                    
                    // 設置建築模型
                    setupBuildingModel();
                    
                    // 更新規格資訊
                    document.getElementById('mesh-count').textContent = meshCount;
                    document.getElementById('lighting-status').textContent = '自然光';
                    
                    updateStatus('🏢 Minnan.fbx 建築展示已就緒！');
                },
                function(progress) {
                    if (progress.lengthComputable) {
                        const percent = Math.round((progress.loaded / progress.total) * 100);
                        updateStatus(`載入進度: ${percent}%`);
                        console.log(`建築載入進度: ${percent}%`);
                    } else {
                        updateStatus('載入中...');
                    }
                },
                function(error) {
                    console.error('❌ Minnan.fbx 載入失敗:', error);
                    updateStatus('❌ Minnan.fbx 載入失敗，使用替代建築模型...');
                    loadAlternativeBuilding();
                }
            );
        }

        function loadAlternativeBuilding() {
            updateStatus('創建建築示範模型...');
            
            // 創建簡單的建築模型
            buildingModel = new THREE.Group();
            
            // 主建築體
            const buildingGeometry = new THREE.BoxGeometry(8, 6, 10);
            const buildingMaterial = new THREE.MeshLambertMaterial({ color: 0xf0f0f0 });
            const building = new THREE.Mesh(buildingGeometry, buildingMaterial);
            building.position.y = 3;
            building.castShadow = true;
            building.receiveShadow = true;
            buildingModel.add(building);
            
            // 屋頂
            const roofGeometry = new THREE.ConeGeometry(6, 3, 4);
            const roofMaterial = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
            const roof = new THREE.Mesh(roofGeometry, roofMaterial);
            roof.position.y = 7.5;
            roof.rotation.y = Math.PI / 4;
            roof.castShadow = true;
            buildingModel.add(roof);
            
            // 門
            const doorGeometry = new THREE.BoxGeometry(1.5, 3, 0.1);
            const doorMaterial = new THREE.MeshLambertMaterial({ color: 0x654321 });
            const door = new THREE.Mesh(doorGeometry, doorMaterial);
            door.position.set(0, 1.5, 5.1);
            buildingModel.add(door);
            
            // 窗戶
            for (let i = 0; i < 4; i++) {
                const windowGeometry = new THREE.BoxGeometry(1, 1, 0.1);
                const windowMaterial = new THREE.MeshLambertMaterial({ color: 0x87CEEB });
                const window = new THREE.Mesh(windowGeometry, windowMaterial);
                window.position.set((i - 1.5) * 2, 4, 5.1);
                buildingModel.add(window);
            }
            
            setupBuildingModel();
            
            document.getElementById('mesh-count').textContent = '6';
            document.getElementById('file-format').textContent = '示範建築';
            
            updateStatus('✅ 建築示範模型已就緒！');
        }

        function setupBuildingModel() {
            // 計算邊界框和縮放
            const box = new THREE.Box3().setFromObject(buildingModel);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            
            const maxDim = Math.max(size.x, size.y, size.z);
            const scale = 8 / maxDim;
            buildingModel.scale.setScalar(scale);
            
            // 重新計算縮放後的中心點
            const scaledBox = new THREE.Box3().setFromObject(buildingModel);
            const scaledCenter = scaledBox.getCenter(new THREE.Vector3());
            
            // 將建築放在地面上
            buildingModel.position.set(
                -scaledCenter.x,
                -scaledBox.min.y,
                -scaledCenter.z
            );
            
            scene.add(buildingModel);
        }

        function setEnvironment(envType) {
            currentEnvironment = envType;
            
            switch(envType) {
                case 'daylight':
                    scene.background = new THREE.Color(0x87CEEB);
                    directionalLight.color.setHex(0xffffff);
                    directionalLight.intensity = 1.2;
                    ambientLight.intensity = 0.4;
                    break;
                case 'sunset':
                    scene.background = new THREE.Color(0xFF8C00);
                    directionalLight.color.setHex(0xFF4500);
                    directionalLight.intensity = 0.8;
                    ambientLight.intensity = 0.3;
                    break;
                case 'night':
                    scene.background = new THREE.Color(0x191970);
                    directionalLight.color.setHex(0x4169E1);
                    directionalLight.intensity = 0.3;
                    ambientLight.intensity = 0.1;
                    break;
                case 'cloudy':
                    scene.background = new THREE.Color(0x708090);
                    directionalLight.color.setHex(0xD3D3D3);
                    directionalLight.intensity = 0.6;
                    ambientLight.intensity = 0.5;
                    break;
            }
            
            document.getElementById('current-environment').textContent = envType;
            updateStatus(`環境已更改為 ${envType}`);
        }

        function randomizeEnvironment() {
            const environments = ['daylight', 'sunset', 'night', 'cloudy'];
            const randomEnv = environments[Math.floor(Math.random() * environments.length)];
            setEnvironment(randomEnv);
        }

        function toggleInteriorLights() {
            interiorLightsOn = !interiorLightsOn;
            
            if (interiorLightsOn) {
                // 添加室內燈光
                for (let i = 0; i < 3; i++) {
                    const light = new THREE.PointLight(0xFFFACD, 0.5, 10);
                    light.position.set((i - 1) * 3, 4, 0);
                    scene.add(light);
                    interiorLights.push(light);
                }
                document.getElementById('lighting-status').textContent = '室內燈光開啟';
                updateStatus('室內燈光已開啟');
            } else {
                // 移除室內燈光
                interiorLights.forEach(light => scene.remove(light));
                interiorLights = [];
                document.getElementById('lighting-status').textContent = '自然光';
                updateStatus('室內燈光已關閉');
            }
        }

        function toggleShadows() {
            shadowsEnabled = !shadowsEnabled;
            renderer.shadowMap.enabled = shadowsEnabled;
            
            if (buildingModel) {
                buildingModel.traverse(function(child) {
                    if (child.isMesh) {
                        child.castShadow = shadowsEnabled;
                        child.receiveShadow = shadowsEnabled;
                    }
                });
            }
            
            updateStatus(shadowsEnabled ? '陰影效果已開啟' : '陰影效果已關閉');
        }

        function adjustAmbientLight() {
            ambientLight.intensity = ambientLight.intensity > 0.5 ? 0.2 : ambientLight.intensity + 0.1;
            updateStatus(`環境光強度: ${ambientLight.intensity.toFixed(1)}`);
        }

        function resetView() {
            camera.position.set(10, 8, 15);
            controls.target.set(0, 0, 0);
            controls.autoRotate = true;
            controls.update();
            updateStatus('視角已重置');
        }

        function toggleWireframe() {
            if (!buildingModel) return;
            
            wireframeMode = !wireframeMode;
            
            buildingModel.traverse(function(child) {
                if (child.isMesh && child.material) {
                    if (Array.isArray(child.material)) {
                        child.material.forEach(mat => {
                            mat.wireframe = wireframeMode;
                            mat.needsUpdate = true;
                        });
                    } else {
                        child.material.wireframe = wireframeMode;
                        child.material.needsUpdate = true;
                    }
                }
            });
            
            updateStatus(wireframeMode ? '已開啟線框模式' : '已關閉線框模式');
        }

        function captureScreenshot() {
            const wasAutoRotating = controls.autoRotate;
            controls.autoRotate = false;
            
            renderer.render(scene, camera);
            
            const canvas = renderer.domElement;
            const link = document.createElement('a');
            link.download = `architecture-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
            
            controls.autoRotate = wasAutoRotating;
            updateStatus('📸 建築截圖已保存');
        }

        function showFloorPlan() {
            alert('平面圖功能：\n\n這裡可以展示建築的平面配置圖\n包含房間布局、功能分區等資訊\n\n此功能可以整合 2D 平面圖顯示');
        }

        function showBuildingSpecs() {
            if (!buildingModel) {
                alert('請先載入建築模型');
                return;
            }
            
            const box = new THREE.Box3().setFromObject(buildingModel);
            const size = box.getSize(new THREE.Vector3());
            
            let meshCount = 0;
            buildingModel.traverse(function(child) {
                if (child.isMesh) meshCount++;
            });
            
            const specs = `建築設計規格資訊:
            
📊 基本資訊:
• 建築類型: 現代住宅
• 模型格式: FBX
• 元件數量: ${meshCount}

📐 建築尺寸:
• 寬度: ${size.x.toFixed(2)} 單位
• 高度: ${size.y.toFixed(2)} 單位
• 深度: ${size.z.toFixed(2)} 單位

🎯 設計特色:
• 光照系統: 建築級渲染
• 環境效果: 多時段光照
• 材質系統: 真實建築材質

💼 應用範圍:
• 建築提案
• 設計競圖
• 客戶展示
• 規劃審查`;
            
            alert(specs);
        }

        function exportProject() {
            const projectData = {
                environment: currentEnvironment,
                wireframe: wireframeMode,
                shadows: shadowsEnabled,
                interiorLights: interiorLightsOn,
                ambientIntensity: ambientLight.intensity,
                cameraPosition: {
                    x: camera.position.x,
                    y: camera.position.y,
                    z: camera.position.z
                },
                timestamp: new Date().toISOString(),
                projectType: 'architecture'
            };
            
            const dataStr = JSON.stringify(projectData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = 'architecture-project.json';
            link.click();
            
            URL.revokeObjectURL(url);
            updateStatus('💾 建築專案已匯出');
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if (controls) {
                controls.update();
            }
            
            renderer.render(scene, camera);
        }

        // 初始化
        init();
        updateStatus('建築視覺化系統初始化完成');
    </script>
</body>
</html>
